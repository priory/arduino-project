#include <Arduino.h>
#include <avr/pgmspace.h>
#include "../lib/Button/src/DigitalButton.h"
#include "../lib/Button/src/InterruptingButton.h"

const uint16_t NOTES[52] PROGMEM = {
        0,   //Rest 0
        65,  //C2   1
        69,  //C#2  2
        73,  //D2   3
        78,  //D#2  4
        82,  //E2   5
        87,  //F2   6
        92,  //F#2  7
        98,  //G2   8
        104, //G#2  9
        110, //A2   10
        117, //A#2  11
        123, //B2   12
        131, //C3   13
        139, //C#3  14
        147, //D3   15
        156, //D#3  16
        165, //E3   17
        175, //F3   18
        185, //F#3  19
        196, //G3   20
        208, //G#3  21
        220, //A3   22
        233, //A#3  23
        247, //B3   24
        262, //C4   25
        277, //C#4  26
        294, //D4   27
        311, //D#4  28
        330, //E4   29
        349, //F4   30
        370, //F#4  31
        392, //G4   32
        415, //G#4  33
        440, //A4   34
        466, //A#4  35
        494, //B4   36
        523, //C5   37
        554, //C#5  38
        587, //D5   39
        622, //D#5  40
        659, //E5   41
        698, //F5   42
        740, //F#5  43
        784, //G5   44
        831, //G#5  45
        880, //A5   46
        932, //A#5  47
        988, //B5   48
        1047, //C6  49
        1109, //C#6 50
        1175, //D6  51
};

/**
 * Note durations
 *
 * 192 = 1
 *
 * 6 = 1/32th
 * 12 = 1/16th
 * 24 = 1/8th
 * 48 = 1/4th
 * 96 = 1/2th
 *
 * 8 = 1/24th
 * 16 = 1/12th
 * 32 = 1/6th
 * 64 = 1/3th
 */

const uint8_t ALL_TRACKS[6][256][2] PROGMEM = {
        // 81 Wintersun - Sons of Winter and Stars                                                      82                                                                                             83                                                                                             84                                                                                             85                                                                                             86                                                                                             93                                                                                             94                                                                                             95                                                                                             96                                                                                             97                                                                                             98
        {{25, 16}, {20, 16}, {13, 16}, {20, 16}, {13, 16}, {20, 16}, {25, 16},  {20, 16}, {13, 16}, {27, 16}, {20, 16}, {13, 16}, {20, 16}, {13, 16}, {20, 16}, {27, 16}, {20, 16}, {13, 16}, {28, 16}, {20, 16}, {13, 16}, {27, 16}, {20, 16}, {13, 16}, {25, 16}, {20, 16}, {13, 16}, {23, 16}, {18, 16}, {11, 16}, {18, 16}, {11, 16}, {18, 16}, {23, 16}, {18, 16}, {11, 16}, {25, 16}, {18, 16}, {11, 16}, {18, 16}, {11, 16}, {18, 16}, {25, 16}, {18, 16}, {11, 16}, {25, 16}, {21, 16}, {16, 16}, {27, 16}, {21, 16}, {16, 16}, {28, 16}, {27, 16}, {28, 16}, {25, 16}, {20, 16}, {13, 16}, {20, 16}, {13, 16}, {20, 16}, {25, 16}, {20, 16}, {13, 16}, {27, 16}, {20, 16}, {13, 16}, {20, 16}, {13, 16}, {20, 16}, {27, 16}, {20, 16}, {27, 16}, {28, 16}, {13, 16}, {28, 16}, {27, 16}, {20, 16}, {13, 16}, {25, 16}, {20, 16}, {13, 16}, {23, 16}, {18, 16}, {11, 16}, {18, 16}, {11, 16}, {18, 16}, {23, 16}, {18, 16}, {11, 16}, {25, 16}, {18, 16}, {11, 16}, {18, 16}, {11, 16}, {18, 16}, {25, 16}, {18, 16}, {11, 16}, {16, 16}, {21, 16}, {16, 16}, {27, 16}, {21, 16}, {27, 16}, {28, 16}, {21, 16}, {28, 16}},
        // 5 Children of Bodom - Downfall                                                   6                                                                                  7                                                                                 8                                                                                  9                                                                                   10                                                                                  11                                                                                  12
        {{23, 24}, {8,  24}, {15, 24}, {20, 24}, {22, 24}, {8,  24}, {15, 24},  {18, 24}, {20, 24}, {15, 24}, {18, 24}, {20, 24}, {8,  24}, {15, 24}, {18, 24}, {20, 24}, {23, 24}, {8,  24}, {15, 24}, {20, 24}, {22, 24}, {8,  24}, {15, 24}, {18, 24}, {20, 24}, {15, 24}, {18, 24}, {20, 24}, {8,  24}, {15, 24}, {18, 24}, {20, 24}, {23, 24}, {11, 24}, {16, 24}, {20, 24}, {22, 24}, {11, 24}, {16, 24}, {18, 24}, {20, 24}, {16, 24}, {18, 24}, {20, 24}, {11, 24}, {16, 24}, {18, 24}, {20, 24}, {23, 24}, {11, 24}, {16, 24}, {20, 24}, {22, 24}, {11, 24}, {16, 24}, {18, 24}, {20, 24}, {16, 24}, {18, 24}, {20, 24}, {11, 24}, {16, 24}, {23, 24}, {22, 24}},
        // 81 Children of Bodom - Red Light in My Eyes, Pt 2                                             82                                                                                             83                                                                                             84                                                                         85                                                                                             86                                                                                             87                                                                                             88                                                                         89                                                                                             90                                                                                             91                                                                                             92
        {{26, 16}, {27, 16}, {24, 16}, {26, 16}, {22, 16}, {24, 16}, {21, 16},  {22, 16}, {24, 16}, {26, 16}, {27, 16}, {24, 16}, {26, 16}, {22, 16}, {24, 16}, {21, 16}, {22, 16}, {24, 16}, {26, 16}, {27, 16}, {24, 16}, {26, 16}, {22, 16}, {24, 16}, {21, 16}, {22, 16}, {24, 16}, {26, 16}, {24, 16}, {22, 16}, {21, 16}, {19, 16}, {17, 16}, {19, 48}, {26, 16}, {27, 16}, {24, 16}, {26, 16}, {22, 16}, {24, 16}, {21, 16}, {22, 16}, {24, 16}, {26, 16}, {27, 16}, {24, 16}, {26, 16}, {22, 16}, {24, 16}, {21, 16}, {22, 16}, {24, 16}, {26, 16}, {27, 16}, {24, 16}, {26, 16}, {22, 16}, {24, 16}, {21, 16}, {22, 16}, {24, 16}, {26, 16}, {24, 16}, {22, 16}, {21, 16}, {19, 16}, {17, 16}, {19, 48}, {26, 16}, {27, 16}, {24, 16}, {26, 16}, {22, 16}, {24, 16}, {21, 16}, {22, 16}, {24, 16}, {26, 16}, {27, 16}, {24, 16}, {26, 16}, {22, 16}, {24, 16}, {21, 16}, {22, 16}, {24, 16}, {29, 16}, {31, 16}, {27, 16}, {29, 16}, {26, 16}, {27, 16}, {24, 16}, {26, 16}, {27, 16}, {26, 16}, {24, 16}, {22, 16}, {21, 16}, {19, 16}, {17, 16}, {19, 48}},
        // 1 IneartheD - Talking of the Trees                              2             3                                                      4
        {{24, 16}, {29, 16}, {34, 16}, {32, 96}, {34, 32}, {39, 16}, {36, 192}, {24, 16}, {29, 16}, {34, 16}, {32, 96}, {31, 48}, {29, 48}, {29, 16}, {31, 16}, {32, 16}, {31, 96}},
        // 18 Synergy - Warrior Princess                                                                                                                                        19                                                                                                                                                                    20                                                                                                                                                                    21                                                                                                                                                                    22                                                                                                                                                                    23                                                                                                                                      24                                                                                                                                                                    25            26                                                                                       27                                                                              28                                                                              29                                                                                    30                                                                                       31                                                                              32                                                                              33
        {{35, 12}, {32, 12}, {28, 12}, {32, 12}, {35, 12}, {32, 12}, {37, 12},  {32, 12}, {35, 12}, {32, 12}, {28, 12}, {32, 12}, {35, 12}, {32, 12}, {37, 12}, {32, 12}, {37, 12}, {34, 12}, {30, 12}, {34, 12}, {37, 12}, {34, 12}, {39, 12}, {34, 12}, {37, 12}, {35, 12}, {30, 12}, {34, 12}, {37, 12}, {34, 12}, {39, 12}, {34, 12}, {39, 12}, {35, 12}, {32, 12}, {35, 12}, {39, 12}, {35, 12}, {40, 12}, {35, 12}, {37, 12}, {34, 12}, {30, 12}, {34, 12}, {37, 12}, {34, 12}, {39, 12}, {34, 12}, {35, 12}, {32, 12}, {28, 12}, {32, 12}, {39, 12}, {40, 12}, {44, 12}, {39, 12}, {40, 12}, {37, 12}, {39, 12}, {40, 12}, {42, 12}, {39, 12}, {40, 12}, {42, 12}, {44, 12}, {40, 12}, {35, 12}, {40, 12}, {44, 12}, {40, 12}, {42, 12}, {40, 12}, {44, 12}, {40, 12}, {35, 12}, {40, 12}, {44, 12}, {40, 12}, {42, 12}, {40, 12}, {46, 12}, {42, 12}, {37, 12}, {42, 12}, {46, 12}, {42, 12}, {44, 12}, {42, 12}, {46, 12}, {42, 12}, {37, 12}, {42, 12}, {46, 48}, {39, 12}, {34, 12}, {32, 12}, {25, 12}, {32, 12}, {34, 12}, {39, 12}, {34, 12}, {32, 12}, {34, 12}, {39, 12}, {34, 12}, {32, 12}, {34, 12}, {39, 12}, {34, 12}, {39, 192}, {14, 32}, {7, 16}, {7, 16}, {7, 16}, {7, 16}, {7, 16}, {7, 16}, {7, 16}, {22, 48}, {7, 16}, {7, 16}, {7, 16}, {7, 16}, {7, 16}, {7, 16}, {22, 48}, {17, 48}, {7, 16}, {7, 16}, {7, 16}, {19, 48}, {7, 16}, {7, 16}, {7, 16}, {17, 48}, {19, 16}, {21, 16}, {22, 16}, {24, 16}, {21, 16}, {22, 16}, {26, 48}, {24, 48}, {14, 32}, {7, 16}, {7, 16}, {7, 16}, {7, 16}, {7, 16}, {7, 16}, {7, 16}, {22, 48}, {7, 16}, {7, 16}, {7, 16}, {7, 16}, {7, 16}, {7, 16}, {22, 48}, {17, 48}, {7, 16}, {7, 16}, {7, 16}, {19, 48}, {7, 16}, {7, 16}, {7, 16}, {17, 48}, {19, 16}, {21, 16}, {22, 16}, {24, 16}, {21, 16}, {22, 16}, {26, 48}, {24, 48}},
        // 127 Maty Friedman - Forbidden City                                                                                                                                   128                                                                                                                                                         129                                                                                                                                                                   130
        {{17, 12}, {17, 12}, {19, 12}, {17, 12}, {20, 12}, {17, 12}, {19, 12},  {17, 12}, {19, 12}, {19, 12}, {20, 12}, {19, 12}, {22, 12}, {19, 12}, {20, 12}, {19, 12}, {20, 12}, {20, 12}, {22, 12}, {20, 12}, {24, 12}, {20, 12}, {22, 12}, {20, 12}, {19, 12}, {20, 12}, {22, 12}, {20, 12}, {19, 12}, {20, 12}, {17, 24}, {17, 12}, {17, 12}, {19, 12}, {17, 12}, {20, 12}, {17, 12}, {19, 12}, {17, 12}, {19, 12}, {19, 12}, {20, 12}, {19, 12}, {22, 12}, {19, 12}, {20, 12}, {19, 12}, {12, 12}, {13, 12}, {17, 12}, {13, 12}, {17, 12}, {20, 12}, {24, 12}, {20, 12}, {22, 12}, {25, 12}, {29, 12}, {25, 12}, {29, 12}, {32, 12}, {36, 12}, {32, 12}, {17, 12}, {17, 12}, {19, 12}, {17, 12}, {20, 12}, {17, 12}, {19, 12}, {17, 12}, {19, 12}, {19, 12}, {20, 12}, {19, 12}, {22, 12}, {19, 12}, {20, 12}, {19, 12}, {20, 12}, {20, 12}, {22, 12}, {20, 12}, {24, 12}, {20, 12}, {22, 12}, {20, 12}, {19, 12}, {20, 12}, {22, 12}, {20, 12}, {19, 12}, {20, 12}, {17, 24}, {17, 12}, {17, 12}, {19, 12}, {17, 12}, {20, 12}, {17, 12}, {19, 12}, {17, 12}, {19, 12}, {19, 12}, {20, 12}, {19, 12}, {22, 12}, {19, 12}, {20, 12}, {19, 12}, {19, 24}, {22, 24}, {22, 24}, {24, 24}, {24, 24}, {26, 24}, {26, 48}},
};

// {bpm, notes}
const uint8_t SONG_PROPS[6][2] PROGMEM = {
        {146, 108},
        {200, 64},
        {190, 102},
        {120, 17},
        {150, 176},
        {168, 117},
};

template<uint16_t MAX_NOTES_IN_TRACK, uint8_t NUM_OF_NOTES>
class MusicPlayer {
public:
    explicit MusicPlayer(uint8_t pin) : _pin(pin) {
        pinMode(_pin, OUTPUT);
    }

    void setNotes(const uint16_t (*notes)[NUM_OF_NOTES]) {
        _notes = notes;
    }

    void setTrack(const uint8_t (*track)[MAX_NOTES_IN_TRACK][2]) {
        _track = track;
    }

    bool isPlaying() {
        return _playing;
    }

    uint8_t getBPM() {
        return _trackBPM;
    }

    void setBPM(uint8_t bpm) {
        _trackBPM = bpm;
        resetInterval();
    }

    unsigned int getTrackNotes() {
        return _trackNotes;
    }

    void setTrackNotes(unsigned int notes) {
        _trackNotes = notes;
    }

    void setupTrack(uint8_t bpm, unsigned int notes) {
        setBPM(bpm);
        setTrackNotes(notes);
    }

    void resetInterval() {
        _interval = 312500 / getBPM();
    }

    void loop(unsigned long int &micro) {
        if (isPlaying()) {
            if (micro - _micro >= _interval) {
                if (_tick == 0) {
                    playNote();
                }
                _tick++;
                if (_tick >= nextNote(1) * 4) {
                    killNote();
                    _tick = 0;
                    _note++;
                    if (_note >= getTrackNotes()) {
                        reset();
                    }
                }
                _micro = micro;
            }
        }
    }

    void play() {
        _playing = true;
    }

    void pause() {
        killNote();
        _playing = false;
    }

    void reset() {
        resetInterval();
        _micro = 0;
        _note = 0;
        _tick = 0;
    }

private:
    uint8_t _pin;
    bool _playing = false;
    unsigned long int _micro = 0;
    unsigned int _tick = 0;
    unsigned int _interval = 0;
    unsigned int _note = 0;
    const uint16_t (*_notes)[NUM_OF_NOTES];
    const uint8_t (*_track)[MAX_NOTES_IN_TRACK][2];
    uint8_t _trackBPM = 120;
    unsigned int _trackNotes = 0;

    uint8_t getNoteProp(unsigned int note, uint8_t prop = 0) {
        return pgm_read_byte(&_track[0][note][prop]);
    }

    uint8_t nextNote(uint8_t prop = 0) {
        return getNoteProp(_note, prop);
    }

    void killNote() {
        noTone(_pin);
    }

    void playNote() {
        unsigned int n = (uint16_t)pgm_read_ptr(&_notes[0][nextNote()]);
        if (n) {
            tone(_pin, n);
        } else {
            killNote();
        }
    }
};

MusicPlayer<256, 52> *mp;

DigitalButton *btnA;
InterruptingButton *btnB;

bool toggleBPM = false;

void setup() {
    Serial.begin(9600);

    mp = new MusicPlayer<256, 52>(11);

    mp->setNotes(&NOTES);
    mp->setTrack(&ALL_TRACKS[0]);
    mp->setupTrack(146, 108);

    btnA = new DigitalButton(12);
    btnA->setOnPressed([] {
        if (mp->isPlaying()) mp->pause();
        else mp->play();
    });

    btnB = new InterruptingButton(2, []{btnB->interruptHandle();});
    btnB->setOnPressed([] {
        toggleBPM ^= 1;
        if (toggleBPM) mp->setBPM(73);
        else mp->setBPM(146);
    });
}

unsigned long int counter = 0;
unsigned long int interval = 100;

void loop() {
    unsigned long int micro = micros();

    if (micro - counter >= interval) {

        counter = micro;
    }

    mp->loop(micro);
    btnA->loop(micro);
    btnB->loop(micro);
}
